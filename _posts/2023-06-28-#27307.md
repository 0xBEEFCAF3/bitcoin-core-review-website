---
layout: pr
date: 2023-06-28
title: "Track mempool conflicts with wallet transactions"
pr: 27307
authors: [ishaanam]
components: ["wallet"]
host: ishaanam
status: upcoming
commit: 0538ad7
---

## Notes
- In Bitcoin Core, every [wallet transaction](https://github.com/bitcoin/bitcoin/blob/7f0b79ea132d22ad5212c1d3ff4325715ca5ac12/src/wallet/transaction.h#L160)
  has a [transaction state](https://github.com/bitcoin/bitcoin/blob/7f0b79ea132d22ad5212c1d3ff4325715ca5ac12/src/wallet/transaction.h#L68) (detailed [here](https://gist.github.com/ishaanam/846adf3b453c3a85fe6e15c882c57ae0#types-of-tx-states)).
  These transaction states are part of how the wallet decides which
  transactions to allow the user to spend, and which transactions to
  count towards a user's balance.

- Wallet transaction states and conflicts were previously discussed in
  review club [#27145](/27145)

- When a transaction is `TxStateInactive`:
    - its inputs are considered spent, and
    - its outputs are not available to spend and don't count towards a
      user's balance

- When a transaction is `TxStateConflicted`:
    - its inputs are _not_ considered spent, and
    - its outputs are not available to spend and don't count towards a
      user's balance

- On master, wallet txs are only considered conflicted when the conflicting tx
  gets mined into a block. This means that if a transaction is only conflicted
  by a mempool tx, it is considered `TxStateInactive` instead. This can lead to
  [confusion](https://bitcoin-irc.chaincode.com/bitcoin-core-dev/2023-05-09#1683605157-1683612219;)
  amongst users, because the funds seem to briefly "disappear".

- This PR treats transactions with conflicts in the mempool as conflicted
  as well, by adding another [transaction state for mempool-conflicted
  transactions](https://github.com/bitcoin/bitcoin/pull/27307/files#diff-d41d68c5a65d67956c91b33ca86da7df1981d84a0b15b4a186deea566563fed5R46-R49)
  and keeping track of the conflicting transactions in
  [`MempoolConflicts`](https://github.com/bitcoin/bitcoin/pull/27307/files#diff-9ce137cd784ea308778842120aa2af6d2bb8369485b71f25e72b2a32cf0a5b21R316-R318),
  a map of wallet tx hashes to a set of their mempool conflicts' tx
  hashes.

- This idea and a previous attempt to implement it is described
  [here](https://github.com/bitcoin-core/bitcoin-devwiki/wiki/Wallet-Transaction-Conflict-Tracking#idea-mempool-conflicted)

## Questions
1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or
NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)?
What was your review approach?

1. Is this PR fixing a bug or adding a feature? What is that
bug/feature?

1. What are the trade-offs with considering a mempool-conflicted
transaction as conflicted instead of inactive?

1. Is the first commit necessary for this PR? Does it change any
existing behavior?

1. What is the point of adding a `MempoolConflicts` map? Why can't the
wallet just check for conflicts in `mapTxSpends`?

1. What is the benefit of adding another transaction state
(`TxStateMempoolConflicted`) instead of just using `TxStateConflicted`?

1. Should a user be able to abandon a transaction with a mempool
conflict? With this PR is a user able to do so?

1. After a wallet is reloaded, what will be the transaction state of a
previously mempool-conflicted transaction?

1. Do the tests added to [`wallet_conflicts.py`](https://github.com/bitcoin-core-review-club/bitcoin/commit/0538ad7d4cfddb5a377f879cbf221b2b028c264a) fail on master for you?

1. This PR doesn't modify any of the balance calculation code directly,
so how do the changes made in this PR affect the balance calculation of
the wallet?xf

1. Are `TxStateConflicted` and `TxStateMempoolConflicted` transactions
treated the same in memory?

1. Are there any additional test cases you would like to see
implemented?

1. Why does `wallet_abandonconflict.py` need to be
modified in the [second commit](https://github.com/bitcoin-core-review-club/bitcoin/commit/285d00523198ce352835d8360f8d79554b03bcd1)?

<!-- TODO: After meeting, uncomment and add meeting log between the irc tags
## Meeting Log

{% irc %}
{% endirc %}
-->
