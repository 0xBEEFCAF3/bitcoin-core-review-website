---
layout: pr
date: 2023-06-07
title: "Remove shutdown from kernel library"
pr: 27711
authors: [TheCharlatan]
components: ["validation"]
host: stickies-v
status: upcoming
commit: a6a3c3245303d05917c04460e71790e33241f3b5
---

## Notes

- The [libbitcoinkernel project](https://github.com/bitcoin/bitcoin/issues/27587) is an effort to decouple Bitcoin Coreâ€™s consensus engine from other non-consensus modules (such as the various indices) in the codebase. We have previously covered libbitcoinkernel-related PRs [#25527](/25527), [#24410](/24410) and [#20158](/20158).

- [#27636](https://github.com/bitcoin/bitcoin/pull/27636) introduced a [`kernel::Notifications` interface](https://github.com/bitcoin/bitcoin/blob/b22408df162a224d94ac54e8443b57ef3fd2ca72/src/kernel/notifications_interface.h#L21), which can then be implemented by node implementations (e.g. [`KernelNotifications`](https://github.com/bitcoin/bitcoin/blob/b22408df162a224d94ac54e8443b57ef3fd2ca72/src/node/kernel_notifications.h#L18)) to trigger the desired behaviour for an event.

- One such type of event is the consensus engine requiring a shutdown, [expectedly](https://github.com/bitcoin/bitcoin/blob/b22408df162a224d94ac54e8443b57ef3fd2ca72/src/node/blockstorage.cpp#L939) or [unexpectedly](https://github.com/bitcoin/bitcoin/blob/b22408df162a224d94ac54e8443b57ef3fd2ca72/src/node/chainstate.cpp#L210).

- This PR [#27711](https://github.com/bitcoin/bitcoin/pull/27711) adds two new notification methods `kernel::Notifications::startShutdown`[](https://github.com/TheCharlatan/bitcoin/commit/a6a3c3245303d05917c04460e71790e33241f3b5#diff-6f5e5a92ba752d079eddefda2bb7a4432c853712d10878369ffd36f45fca204dR45) and [`kernel::Notifications::fatalError`](https://github.com/TheCharlatan/bitcoin/commit/2db5ddf52b4b8100b03c1235d3e94a00d66a16cb#diff-6f5e5a92ba752d079eddefda2bb7a4432c853712d10878369ffd36f45fca204dR36) to allow the node to implement the necessary behaviour.

- Moreover, this PR moves the shutdown files as well as the remaining usages of `uiInterface` out of the kernel code, as started in [#27636](https://github.com/bitcoin/bitcoin/pull/27636).

## Questions

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)? What was your review approach?

1. Why do we have `startShutdown` both in `kernel/notifications_interface.h` as well as in `node/kernel_notifications.h`?

1. How does [`fRequestShutdown`](https://github.com/bitcoin/bitcoin/blob/b22408df162a224d94ac54e8443b57ef3fd2ca72/src/shutdown.cpp#L35) relate to this PR, and can you elaborate on its role in terminating long-running kernel functions?

1. How does the notification interface contribute to the decoupling of most non-consensus code from libbitcoinkernel?

1. Can you describe the flow of `startShutdown` and `fatalError` notifications in this new setup? Who are the producers and consumers of these notifications?

1. Are there any potential race conditions or synchronization issues that might arise with the use of the notification interface in this context?

1. Why is [`KernelNotifications::m_shutdown_requested`](https://github.com/bitcoin-core-review-club/bitcoin/commit/2db5ddf52b4b8100b03c1235d3e94a00d66a16cb#diff-04e685224f1ac5bfd91d47d8d7528a2e44f94fab5535d4b6b5af79b5a13aeb93R94) a reference value? Do you have any ideas for alternative approaches to triggering a shutdown?


<!-- TODO: After meeting, uncomment and add meeting log between the irc tags
## Meeting Log

{% irc %}
{% endirc %}
-->
