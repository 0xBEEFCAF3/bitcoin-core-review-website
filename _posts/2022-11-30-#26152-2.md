---
layout: pr
date: 2022-11-30
title: "Bump unconfirmed ancestor transactions to target feerate"
pr: 26152
authors: [Xekyo]
components: ["wallet"]
host: glozow
status: upcoming
commit: 898ad9d590
---

## Notes

See notes from [last week's meeting](/26152).

## Questions

1. The `MiniMiner`
   [constructor](https://github.com/bitcoin-core-review-club/bitcoin/blob/b669fd94f84e679d4549ef0abe1b0483e1406152/src/node/mini_miner.h#L94)
accepts a mempool reference and a list of outpoints the wallet might be interested in spending.
Given an outpoint, it may be one of four possible types:

    - a confirmed UTXO
    - a UTXO created by a mempool transaction and has not been spent yet
    - a UTXO created by a mempool transaction and has already been spent by another mempool
      transaction
    - a UTXO that does not exist in mempool or chainstate (perhaps not yet submitted to mempool)

   How does the `MiniMiner` constructor detect and handle each case?

1. `MiniMiner` builds a `descendant_set_by_txid` cache, but not an `ancestor_set_by_txid` cache.
   Instead, it
[calculates](https://github.com/bitcoin-core-review-club/bitcoin/blob/b669fd94f84e679d4549ef0abe1b0483e1406152/src/node/mini_miner.cpp#L145-L161)
ancestor sets on the fly. Do you think this approach makes sense? Why or why not?

1. One potential approach for constructing the block is to define a custom ancestor score comparator
   for `MockMempoolEntry` (or even just reuse
[`CompareTxMemPoolEntryByAncestorFee`](https://github.com/bitcoin/bitcoin/blob/aeb395dcdbfe2b1a6c77ff218939a18afde3add9/src/txmempool.h#L277) from txmempool like the `BlockAssembler`
[does](https://github.com/bitcoin/bitcoin/blob/aeb395dcdbfe2b1a6c77ff218939a18afde3add9/src/node/miner.cpp#L347)),
and then iterate through a list of entries sorted by ancestor score. Why would this approach work for
`BlockAssembler` but not for `MiniMiner`?

1. This functionality is only used by the wallet. Instead of adding `CalculateBumpFees` to the [chain
   interface](https://github.com/bitcoin/bitcoin/pull/26152/commits/8b8bf19951c5877bd39a02a3e39ce246fadd3678),
should we just add it as a utility function in the wallet?

1. Describe the approach taken in the "Bump unconfirmed parent txs to target feerate"
   [commit](https://github.com/bitcoin/bitcoin/pull/26152/commits/ad8bffe548a2536f925e6911c7d50c1aaab1a59e).

1. What test cases are included in wallet\_spend\_unconfirmed.py added in the same
   [commit](https://github.com/bitcoin/bitcoin/pull/26152/commits/ad8bffe548a2536f925e6911c7d50c1aaab1a59e)?
Can you think of any other test cases to add?

1. Two coin selection results may require different fees for bumping ancestors. How does
   the wallet choose which one to use? (Hint: can you identify how bump fees come into play in
[`GetSelectionWaste()`](https://github.com/bitcoin-core-review-club/bitcoin/blob/898ad9d5904f1b689d18d94f20d92500cf443758/src/wallet/coinselection.cpp#L372))?

1. How does the PR handle spending unconfirmed UTXOs with overlapping ancestry? (Hint: what does the code
   [here](https://github.com/bitcoin-core-review-club/bitcoin/blob/898ad9d5904f1b689d18d94f20d92500cf443758/src/wallet/spend.cpp#L584) do)?

