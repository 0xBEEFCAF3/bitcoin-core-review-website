---
layout: pr
date: 2022-07-06
title: "Fix chain tip data race and corrupt rest response"
pr: 25077
authors: [MarcoFalke]
components: ["validation"]
host: MarcoFalke
status: upcoming
commit:
---


## Notes

* It is a [data race (undefined
  behavior)](https://en.cppreference.com/w/cpp/language/memory_model#Threads_and_data_races)
  when a thread writes to memory that another thread is reading or writing.
  `std::mutex` and `std::atomic` can be used to guard against data races.

* Compilers such as gcc and clang can instrument the binary to detect data
  races with the flag
  [`-fsanitize=thread`](https://clang.llvm.org/docs/ThreadSanitizer.html).
  In Bitcoin Core it can be set via `./configure --with-sanitizers=thread`.

* However, data races may only happen intermittently and detection is not
  guaranteed, even if the program is fed the same inputs.

* In Bitcoin Core, validation code is protected by the `cs_main` global
  recursive mutex.

## Questions

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)?

1. Which two threads cause the data race fixed in this pull request? What is
   their purpose? Refer to the traceback in the pull request description.

1. How is the data race fixed in the pull request?

1. What is the other issue fixed by the change? Why is it impossible to detect
   that issue with a thread sanitizer that detects data races?

1. How is the "logical race" fixed in the pull request?

1. Do you agree with the direction of the change to introduce a `GetMutex()`
   alias for the `::cs_main` mutex?

<!-- TODO: After meeting, uncomment and add meeting log between the irc tags
## Meeting Log

{% irc %}
{% endirc %}
-->
