---
layout: pr
date: 2022-04-13
title: "Improve Indices on pruned nodes via prune blockers"
pr: 21726
authors: [fjahr]
components: ["utxo db and indexes", "rpc/rest/zmq"]
host: mzumsande
status: upcoming
commit: 2faa5b5179
---

## Notes

* Indexes are optional modules that scan each block of the chain and store index-specific
additional data in a separate LevelDB database. There are currently three indexes in bitcoin core with very
different use cases that are all using a common framework (`index/base`).

* All indexes have a `best block` which is the block height up to which they are synced.

* In principle, indexes can also work with a node that is running in pruned mode - as long as the
data of each block was indexed at a point in time when the block was still available.
After a block has been processed by the index, this block could be pruned
(the indexed data itself is never pruned).

* However, when pruning with an index enabled, extra care must be taken:

    - We must ensure no blocks are pruned that still need to be indexed.

    - We must take into account the possibility of a reorg. In particular,
    coinstatsindex has a running hash for the UTXO set, so when a block is
    disconnected from the tip, this block's data needs to be available
    in order to be able to adjust the running hash.

    - Being optional, indexes can be switched off (and switched back on again) at any point.
    If it is impossible to fully sync an index because of missing block data, the user
    must be notified.

* [PR #15946](https://github.com/bitcoin/bitcoin/pull/15946) enabled pruning for
    blockfilterindex - however, a negative side-effect of this was that it introduced a circular
    dependency between validation and the index code.

* This PR introduces a new method for pruning, prune locks. It removes the circular
dependency and enables pruning for coinstatsindex.


## Questions

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or
   NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)?

1. Can you summarize what indexes currently exist in bitcoin core, and what each of them does?

1. What is a circular dependency, and why do we want to avoid these when possible?

1. Please explain in your own words how the prune blockers introduced in commit
   [527ef44](https://github.com/bitcoin-core-review-club/bitcoin/commit/527ef4463b23ab8c80b8502cd833d64245c5cfc4)
work.

1. What is the difference to the old approach (which is removed
   [here](https://github.com/bitcoin-core-review-club/bitcoin/commit/3b8b898d96f570489238a4aa21cf4fe27a4a7e73#diff-97c3a52bc5fad452d82670a7fd291800bae20c7bc35bb82686c2c0a4ea7b5b98L2278-L2281))?
- Is there a cost related to the new approach?

1. Why do you think a buffer of 10 blocks (`PRUNE_LOCK_BUFFER`) was introduced?


<!-- TODO: After meeting, uncomment and add meeting log between the irc tags
## Meeting Log

{% irc %}
{% endirc %}
-->
