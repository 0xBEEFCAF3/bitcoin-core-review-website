---
layout: pr
date: 2022-08-31
title: "Advertise `NODE_REPLACE_BY_FEE` and connect to 1 outbound full-rbf peer if `mempoolfullrbf` sets"
pr: 25600
authors: [ariard]
components: ["p2p"]
host: mzumsande
status: upcoming
commit:
---

## Notes

- [Bitcoin Core's RBF policy](https://github.com/bitcoin/bitcoin/blob/23.x/doc/policy/mempool-replacements.md#mempool-replacements)
enables unconfirmed transactions to be replaced by conflicting transactions ("double spends") under certain
conditions. If these conditions are met, nodes will replace the transaction
in their mempool and relay the replacement transaction to their peers.

- The default policy requires opt-in [BIP 125 signaling](https://github.com/bitcoin/bips/blob/master/bip-0125.mediawiki):
Only original transactions that signal
replaceability (using the `nSequence` field on one of its inputs) are subject to replacement.
If the original transaction didn't signal replaceability, the replacement transaction
will be neither accepted nor relayed.

- For L2 protocols, the necessity to opt-in to RBF poses DoS problems, see
[this mailing list post](https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2022-June/020557.html)
for a summary of research.
Therefore, it has been suggested to make full-RBF possible (removing the necessity to opt in).

- As a first step, [PR #25353](https://github.com/bitcoin/bitcoin/pull/25353) added an optional
`-mempoolfullrbf` parameter to Bitcoin Core, which is disabled by default.
If the node operator enables this, the node will ignore the signaling (but will still adhere to other RBF rules).

- This PR goes one step further by implementing a preferential peering solution for peers that
have `-mempoolfullrbf` enabled. These peers would now advertise a full-RBF policy using [service flags](https://github.com/bitcoin/bitcoin/blob/e191fac4f3c37820f0618f72f0a8e8b524531ab8/src/protocol.h#L267)
and make additional automatic outbound connections to peers that also support full-RBF.

## Questions

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)?

1. What network-level conditions must be fulfilled for full-RBF to "work", i.e.,
facilitate the propagation of transactions that replace others not signaling BIP 125?
Is it necessary that every node or the majority of nodes need to support it?

1. This PR currently suggests to make 4 additional connections to full-RBF peers (1 in an earlier version).
What should be considered when picking this number? What are the downsides of having
too few / too many connections?

1. What happens if service flags (such as `NODE_REPLACE_BY_FEE`) a peer tells us in
their version message are different from the service flags we had saved in `AddrMan`?
Is the logic different when we learn from an `addr` message instead from the peer
themselves? Does it matter if the updated entry has less or more service flags than the old one?
(Hint: Look at [AddrMan::AddSingle](https://github.com/bitcoin/bitcoin/blob/e191fac4f3c37820f0618f72f0a8e8b524531ab8/src/addrman.cpp#L546)
and [AddrMan::SetServices_](https://github.com/bitcoin/bitcoin/blob/e191fac4f3c37820f0618f72f0a8e8b524531ab8/src/addrman.cpp#L835))

1. With this in mind, do you think that false signaling of a `NODE_REPLACE_BY_FEE` service flag
could be problem? Could it be detected and punished?

1. Which of the following ways to proceed do you prefer and why:

    * Preferential peering (this PR)

    * Changing the default to `-mempoolfullrbf = 1`

    * Status quo (leave it up to users to actively pick `-mempoolfullrbf = 1`)

    * Something else?



<!-- TODO: After meeting, uncomment and add meeting log between the irc tags
## Meeting Log

{% irc %}
{% endirc %}
-->
