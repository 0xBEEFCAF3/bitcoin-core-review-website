---
layout: pr
date: 2022-03-02
title: "Delete anchors.dat after trying to connect to that peers"
pr: 24034
authors: [brunoerg]
components: ["p2p"]
host: brunoerg
status: upcoming
commit:
---

## Notes
* In Feb 2020, we discussed [#17428](https://github.com/bitcoin/bitcoin/pull/17428), a PR to prevent a type of eclipse attack where an attacker exploits a victim node restart to force it to connect to new, probably adversarial, peers.

* All outbound block-relay-only connections are dumped to anchors.dat file. When you restart a node, it tries to connect to the addresses from anchors.dat.

* I recommend you [read the notes](/17428) from that meeting to understand more about that of attack, how that PR mitigates it, and then you will be able to understand what we are proposing here.

### PR Description
In the current scenario, anchors.dat is deleted right after reading it when a node starts. However, if a node stops before trying to connect to that anchor peers, it will create an empty anchors.dat. So, an attacker could make a node shutdown before it tries to connect to that peers to create an empty anchors.dat making a node connect with new peers (possible malicious ones) when starting again.

This PR changes it to delete anchors.dat after trying to connect to the peers from it. So, if a node stops before trying to connect to that peers, the anchors.dat file will be preserved. Also, we avoid calls to DumpAnchors if a connection to all peers from anchors.dat has not been tried.

## Questions
1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)?

1. Quick review: Whatâ€™s an eclipse attack and how [#17428](https://github.com/bitcoin/bitcoin/pull/17428) prevent it?

1. Why do we delete anchors.dat? Why not just read and write?

1. There are two ways to shutdown a node: in a clean way and unclean one. In the current scenario, what happens if we shutdown (explain it for the two scenarios: clean and unclean) a node before it tried to connect to the peers from anchors.dat?

1. This PR changes when a node delete anchors.dat. When do we delete it?

1. Avoiding delete anchors.dat file before trying to connect to all peers from it is not enough to preserve it in a clean shutdown. Why? How this PR solves it?

<!-- TODO: After meeting, uncomment and add meeting log between the irc tags
## Meeting Log

{% irc %}
{% endirc %}
-->