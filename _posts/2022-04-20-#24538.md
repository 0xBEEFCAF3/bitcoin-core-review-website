---
layout: pr
date: 2022-04-20
title: "bug fix: update for ancestor inclusion using modified fees, not base"
pr: 24538
authors: [glozow]
components: ["mining"]
host: glozow
status: upcoming
commit:
---

## Notes

-  Miners can retrieve a *block template*, a consensus-valid block excluding the proof of work
   (usually computed on separate, dedicated hardware) using the `getblocktemplate` RPC. The "miner"
([`BlockAssembler`](https://github.com/bitcoin/bitcoin/blob/f3e0ace8ecd84009a23da6b0de47f01d79c45772/src/node/miner.h#L128))
generates this template using transactions from the mempool, attempting to maximize the fees in the
block while staying within the block weight and sigop limits.

- Miners can also use the `prioritisetransaction` RPC to artificially raise or lower the fees of
  specific transactions in their own mempools. The prioritisation is achieved through a
[fee delta](https://github.com/bitcoin/bitcoin/blob/f3e0ace8ecd84009a23da6b0de47f01d79c45772/src/txmempool.h#L104).
The "modified fee" of a transaction is the sum of its base fee (total output value subtracted from
total input value) and the fee delta.

- [PR #7594](https://github.com/bitcoin/bitcoin/pull/7594) added ancestor package tracking to the
  mempool. The mempool caches every transaction's *ancestor feerate* (total modified fees divided by
total virtual size of the transaction and all of the transactions it depends upon to be mined).

- [PR #7600](https://github.com/bitcoin/bitcoin/pull/7600) changed the mining algorithm to use
  ancestor packages rather than individual transactions, which improves assessments of the incentive
compatibility of transactions and enables Child Pays for Parent (CPFP) fee-bumping.

	- The algorithm adds transactions from the mempool in *ancestor feerate* order; every time
	  it adds a transaction to the block template, it also adds each of its ancestors and
	  updates the remaining transactions in the mempool accordingly.

	- Rather than edit the mempool transactions itself, the miner creates a copy of the updated
	  entries in [`mapModifiedTx`](https://github.com/bitcoin/bitcoin/blob/f3e0ace8ecd84009a23da6b0de47f01d79c45772/src/node/miner.cpp#L309).

	- Review on [#24364](https://github.com/bitcoin/bitcoin/pull/24364) unearthed some
	  unexpected behavior in the way these entries are edited.

	- [PR #24538](https://github.com/bitcoin/bitcoin/pull/24538) fixes this unexpected behavior
	  and adds unit tests for mining prioritised transactions.

## Questions

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or
   NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)?
How did you review the PR - did you try reproducing the bug?

2. What does ancestor feerate include?

3. In your own words, how does the mining algorithm work (Hint: the main logic can be found in
[`addPackageTxs()`](https://github.com/bitcoin/bitcoin/blob/f3e0ace8ecd84009a23da6b0de47f01d79c45772/src/node/miner.cpp#L303))?

	3a. In what scenario does a transaction get added to `mapModifiedTx`?

	3b. In what scenario does an entry in `mapModifiedTx` get further modified?

4. What is the bug fixed by this PR? Can you construct a specific case in which the bug leads to a
lower-fee transaction being included in the mempool? (Hint: the PR adds a test).

(Bonus Mining Questions)

1. Why is
   [`MAX_CONSECUTIVE_FAILURES`](https://github.com/bitcoin/bitcoin/blob/f3e0ace8ecd84009a23da6b0de47f01d79c45772/src/node/miner.cpp#L323)
necessary?

2. Could the `prioritisetransaction` RPC (and fee deltas) be replaced with parameters to
`getblocktemplate` to force-include or force-exclude transactions?

3. What two indexes can the
   [`indexed_modified_transaction_set`](https://github.com/bitcoin/bitcoin/blob/f3e0ace8ecd84009a23da6b0de47f01d79c45772/src/node/miner.h#L108)
be sorted by?

<!-- TODO: After meeting, uncomment and add meeting log between the irc tags
## Meeting Log

{% irc %}
{% endirc %}
-->
