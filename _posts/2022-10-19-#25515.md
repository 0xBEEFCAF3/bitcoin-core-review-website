---
layout: pr
date: 2022-10-19
title: "Virtualise CConnman and add initial PeerManager unit tests"
pr: 25515
authors: [dergoegge]
components: ["p2p", "tests"]
host: larryruane
status: upcoming
commit: f98a4e8d89
---

## Notes

- [PR 25515](https://github.com/bitcoin/bitcoin/pull/25515) is a refactoring change that
allows unit-testing of the
[`PeerManager`](https://github.com/bitcoin/bitcoin/blob/a52ff619a45c760f657413cbd40e1e2226068541/src/net_processing.h#L41)
object. It also adds a new unit test file,
[`peerman_tests.cpp`](https://github.com/dergoegge/bitcoin/blob/2022-06-virt-connman/src/test/peerman_tests.cpp)
with two unit tests.

- When creating a `PeerManager` class instance
([`PeerManager::make()`](https://github.com/bitcoin/bitcoin/blob/e7a0e9627196655be5aa6c2738d4b57646a03726/src/net_processing.cpp#L1764)),
the caller used to pass (among other things)
a `CConnman` reference. This PR changes the argument to be a
[`ConnectionsInterface`](https://github.com/bitcoin-core-review-club/bitcoin/commit/4f2533c5fd18aea8af86623b2904e7f987465a59#diff-422879cc8bfac56d4380c865f381b58afeb344bc355bbc7f47c581e4491b6b4bR667)
reference.

- This reference is stored in the `PeerManager`'s
[`m_connman`](https://github.com/bitcoin-core-review-club/bitcoin/commit/9efcd9668d143afa2e8213a7bacf94da7f645e4c#diff-6875de769e90cec84d2e8a9c1b962cdbcda44d870d42e4215827e599e11e90e3R704)
member; this PR changes its type.

- This member's functions used to directly call `CConnMan` methods, but now
they call the `ConnectionsInterface`'s virtual methods. These
map to `CConnMan` methods when running the node in production,
so there is no functional change in production.

- However, `m_connman`'s methods can
alternatively be mapped to another class's methods, as long as this
class implements the `ConnectionsInterface` interface (provides all
the same functions).

- This is indeed what is done in the new unit test, where
`PeerManager::make()` is
[passed](https://github.com/bitcoin-core-review-club/bitcoin/commit/84f7266a28870312e69afc6ef72c8e76b19c2662#diff-aafd7c9690634ecdad15d527c2bab6bffbcddd2db444a6099da0305d2d2271beR165-R166)
a reference to a
[`ConnectionsInterfaceMock`](https://github.com/bitcoin-core-review-club/bitcoin/commit/84f7266a28870312e69afc6ef72c8e76b19c2662#diff-aafd7c9690634ecdad15d527c2bab6bffbcddd2db444a6099da0305d2d2271beR37)
object, which was created just for these unit tests.


## Questions

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)?

1. Why do we need unit tests? Aren't functional tests sufficient?

1. Why do we need to mock `CConnman` to unit test `PeerManager`?

1. Do mock interfaces need to implement all of the real interfaces?

1. Should we mock other components as well? (e.g.: `CTxMempool`, `ChainstateManager`)

1. Roughly, what is the overhead of using an interface class?

1. How can you tell that a class is an interface class?

1. What do the `= 0` indicate at the definition of each `ConnectionsInterface` method?
What would happen if they weren't there?



<!-- TODO: After meeting, uncomment and add meeting log between the irc tags
## Meeting Log

{% irc %}
{% endirc %}
-->
