---
layout: pr
date: 2022-08-03
title: "Decouple validation cache initialization from `ArgsManager`"
pr: 25527
authors: [dongcarl]
components: ["refactoring"]
host: glozow
status: upcoming
commit: d29f2fd
---

## Notes

- The [libbitcoinkernel project](https://github.com/bitcoin/bitcoin/issues/24303) is an effort to
  decouple Bitcoin Coreâ€™s consensus engine from other non-consensus modules (such as the various
indices) in the codebase. Previously, we have covered libbitcoinkernel-related PRs [#24410](/24410)
and [#20158](/20158).

- [`ArgsManager`](https://github.com/bitcoin/bitcoin/blob/5871b5b5ab57a0caf9b7514eb162c491c83281d5/src/util/system.h#L172)
  is a Bitcoin Core-specific data structure responsible for handling configuration options. It
returns help strings for configuration options, parses user input, and stores the configured values.
While this functionality is helpful for users that want to customize their nodes, not every node
participating in the network needs it.

- Script (specifically, signature) verification is the most computationally expensive part of
  validating a transaction. The validation caches,
[`g_signatureCache`](https://github.com/bitcoin/bitcoin/blob/5215c80edcd031acf3911e8d824a843f817c6900/src/script/sigcache.cpp#L90) and
[`g_scriptExecutionCache`](https://github.com/bitcoin/bitcoin/blob/5215c80edcd031acf3911e8d824a843f817c6900/src/validation.cpp#L1654),
speed up block validation performance by caching successful signatures and scripts, respectively,
validated when transactions were submitted to the node's mempool.

    - The debug-only `-maxsigcachesize` option limits the aggregate memory usage of both caches.

    - The caches are cuckoo caches, introduced in
      [PR #8895](https://github.com/bitcoin/bitcoin/pull/8895). Also see
      [Cuckoo hash tables](https://en.wikipedia.org/wiki/Cuckoo_hashing) if you are interested.

    - You do not need to fully understand cuckoo cache and validation cache usage to review this PR,
      but feel free to take the scenic route if it piques your interest. Also, looking at the
      implementation of `CheckInputScripts()` may help clarify what is going on in
      txvalidationcache_tests.

- [PR #25527](https://github.com/bitcoin/bitcoin/pull/25527) is one of a series of PRs that
  decouples `ArgsManager` from kernel-related code (see also
[#25290](https://github.com/bitcoin/bitcoin/pull/25290) and
[#25487](https://github.com/bitcoin/bitcoin/pull/25487)). Specifically, it removes uses of
`ArgsManager` when initializing the signature and script caches. It also removes a limit on
signature cache sizes (`MAX_MAX_SIG_CACHE_SIZE`), patches a uint32 overflow, and other cleanups.

## Questions

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)?

1. In your own words, what does the `ArgsManager` do? Why or why not should it belong in src/kernel
   vs src/node?

1. Which uses of `ArgsManager gArgs` are being removed in this PR? What are they replaced with?

1. [This
   commit](https://github.com/bitcoin-core-review-club/bitcoin/commit/1124ead57af262f57ac83205467b4366124408c1)
removes the call to `InitScriptExecutionCache()` in txvalidationcache\_tests.cpp/checkinputs\_test.
How can you verify that this call was unnecessary?

    (Hint a) What do setting `cacheSigStore` and `cacheFullScriptStore` do in [`CheckInputScripts()`](https://github.com/bitcoin/bitcoin/blob/eeb5a94e275fdf02a4af5a9284bcf2515c54aa1f/src/validation.cpp#L1692)?

    (Hint b) What needs to be called/initialized for the test to use the script cache?

    (Hint c) The checkinputs_test test case uses `Dersig100Setup`. How can you check if this has a script cache setup?

1. Describe the uint32 overflow in [this
   commit](https://github.com/bitcoin/bitcoin/pull/25527/commits/3c5555de81ab7f51c655dadffc5e939c4515f65d). Under what conditions would it get hit?

1. [This commit](https://github.com/bitcoin-core-review-club/bitcoin/commit/f66cd5b3aa25f27638b05fbffde7470dd844951b) returns approximate total size from
   [`InitSignatureCache()`](https://github.com/bitcoin-core-review-club/bitcoin/commit/f66cd5b3aa25f27638b05fbffde7470dd844951b#diff-0618dae2990d096e96e0283f7ab8cee069469f1ce603b58c0bb289e154f3aa17R36)
and
[`InitScriptExecutionCache`](https://github.com/bitcoin-core-review-club/bitcoin/commit/f66cd5b3aa25f27638b05fbffde7470dd844951b#diff-d3c243938494b10666b44404a27af7d84b44a72b85a27431e0c89e181462ca6eR327).
It also adds the [`[[nodiscard]]`](https://en.cppreference.com/w/cpp/language/attributes/nodiscard)
attribute to both functions. What does `[[nodiscard]]` do, and why
or why not is it appropriate to add here?

1. [This
   commit](https://github.com/bitcoin-core-review-club/bitcoin/commit/d29f2fd9b49ac00a3721af7260dbbf59e9e8387c)
changes the type of `signature_cache_bytes` and `script_execution_cache_bytes` from `int64_t` to
`size_t`. What is the difference between `int64_t`, `uint64_t`, and `size_t`, and why should
a `size_t` hold these values?

1. What is the maximum value for `ValidationCacheSizes::signature_cache_bytes` after [this
   diff](https://github.com/bitcoin-core-review-club/bitcoin/commit/d29f2fd9b49ac00a3721af7260dbbf59e9e8387c#diff-f36fa9dcd326237b98e6d365b03eea9af04bccd5a555fdf91f402cafc7d20cdcR26-R29)?
Is this a behavior change? Why or why not is the code correct?

1. The
   [commit](https://github.com/bitcoin-core-review-club/bitcoin/commit/e4d5bab88e9acad53cb8d636d836d2cdf9bb49b8)
introducing src/node/validation\_cache\_args
[adds](https://github.com/bitcoin-core-review-club/bitcoin/commit/e4d5bab88e9acad53cb8d636d836d2cdf9bb49b8#diff-5aa4eb91717e30e73956da744da7d89de289d4bcca940b73a6285ea547275a94R47)
it to the [include-what-you-use CI check](https://github.com/bitcoin/bitcoin/pull/24831) CI. What
does this check do? Were you able to run it yourself?

1. Quiz: A mainnet node receives a new block at height 710,000 containing a few transactions. Which
   of the following transactions could hit its script cache, assuming nothing has been evicted?
(Note: taproot activated at height 709,632)

```
(A) the coinbase transaction
(B) a transaction the node has never seen before
(C) a transaction with the same txid but different witness as a transaction in its mempool
(D) a transaction that was in its mempool but replaced by another
(E) a transaction with no taproot inputs or outputs accepted to the mempool at height 709,000
(F) All of the above
(G) None of the above
```
<!-- TODO: After meeting, uncomment and add meeting log between the irc tags
## Meeting Log

{% irc %}
{% endirc %}
-->
