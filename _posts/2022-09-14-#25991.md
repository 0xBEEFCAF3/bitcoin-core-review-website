---
layout: pr
date: 2022-09-14
title: "Add foreign_outputs metadata to support CoinJoin transactions"
pr: 25991
authors: [luke-jr]
components: ["wallet"]
host: stickies-v
status: upcoming
commit: 10bbb0a
---

## Notes

- [CoinJoin](https://bitcoinops.org/en/topics/coinjoin) is a trustless protocol for mixing UTXOs from multiple owners in order to make it difficult for outside parties to use the block chainâ€™s transaction history to determine who owns which coin. It involves collaboratively creating a single transaction that spends one or multiple UTXOs from each participant into one or multiple new UTXOs for each participant, making it more difficult to trace each output's transaction history.

- In a very simple form: Alice, Bob and Carol each provide a 1.1 BTC UTXO and generate an address they want to receive their outputs into. Alice creates a transaction that spends those 3.3 BTC into 3 outputs of 1 BTC (and 0.3 BTC as fee), one to each of the 3 addresses generated by the participants. Alice, Bob and Carol will all need to sign the transaction, since only they can sign for their own inputs. Once all signatures have been added to the transaction, anyone can broadcast it and the CoinJoin is complete. At no point did any of the participants have access to anyone else's coins.

- Many different CoinJoin implementations exist (e.g. some allow non-uniform outputs, others don't), but this is beyond the scope of this PR and Review Club.

- Prior to #25991, [`gettransaction`](https://bitcoincore.org/en/doc/22.0.0/rpc/wallet/gettransaction/) incorrectly calculates the fee because it is assumed that all of the outputs are sent by the user, as shown in the [underlying issue](https://github.com/bitcoin/bitcoin/issues/14136) this PR is aiming to fix.

## Questions
1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)?

1. We already have [`CWallet::IsMine()`](https://github.com/bitcoin/bitcoin/blob/5558d2f5496d8fe1c16f9edd1ef395fcd842e6fb/src/wallet/wallet.cpp#L1413-L1421) - why do we need the new function [`CWalletTx::IsForeignOutput()`](https://github.com/bitcoin-core-review-club/bitcoin/blob/10bbb0a5252470c5afe17c38326476be4a523613/src/wallet/transaction.h#L335-L337)? What is the difference between these functions? What is a foreign output?

1. Does commit ["Wallet: Refactor CachedTxGetAmounts fee calculation to inline value_out"](https://github.com/bitcoin/bitcoin/pull/25991/commits/efa22dd36f1399c49c5a149ace5232b700c7b049) introduce any behaviour change, or is it just refactoring?

1. The [developer notes](https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#coding-style-c) indicate a preference for pre- instead of [post-increment and decrement operators](https://en.cppreference.com/w/cpp/language/operator_incdec). In [`CWalletTx::SetForeignOutput`](https://github.com/bitcoin-core-review-club/bitcoin/blob/10bbb0a5252470c5afe17c38326476be4a523613/src/wallet/transaction.cpp#L28-L36), the post-decrement `i--` is used. Should this be changed, or is it a valid exception to the guideline? Why?

1. [`CWalletTx::m_foreign_outputs`](https://github.com/bitcoin-core-review-club/bitcoin/blob/10bbb0a5252470c5afe17c38326476be4a523613/src/wallet/transaction.h#L193) is implemented as a `std::vector<bool>`. Is there anything peculiar about `std::vector<bool>`? Which other data structure(s) would you consider using instead, if any - and why?

1. What is the purpose of [this](https://github.com/bitcoin-core-review-club/bitcoin/blob/10bbb0a5252470c5afe17c38326476be4a523613/src/wallet/transaction.h#L246-L248) for-loop in `CWalletTx::Init()`? For i=3, what is the value of `1 << (i % 8)` - and what does it mean? *(Hint: what does the `[]` operator on a `std::string` return, and what is the size of that return value?)*

1. Are the foreign outputs persisted to disk? If no, why is this not necessary? If yes, which code is responsible for doing that?


<!-- TODO: After meeting, uncomment and add meeting log between the irc tags
## Meeting Log

{% irc %}
{% endirc %}
-->
