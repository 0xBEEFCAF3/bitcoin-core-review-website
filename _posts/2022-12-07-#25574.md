---
layout: pr
date: 2022-12-07
title: "Improve error handling when VerifyDB fails due to insufficient dbcache"
pr: 25574
authors: [mzumsande]
components: ["validation"]
host: mzumsande
status: upcoming
commit:
---

## Notes
- `VerifyDB` (added in [PR 2145](https://github.com/bitcoin/bitcoin/pull/2145))
performs various checks for possible corruption of recent blocks stored on disk
and of the UTXO database. The check is invoked during startup, but can also be
triggered by the [`verifychain` RPC](https://developer.bitcoin.org/reference/rpc/verifychain.html).

- `VerifyDB` is dependent on two parameters that are available as startup options
or RPC arguments: `-checkblocks` defines to how many blocks (from the tip) the
check is applied, `-checklevel` defines how thorough these checks are.

- It is possible that that due to an insufficient dbcache size, `VerifyDB` can fail
to complete the level 3 checks, in which it would gracefully skip these, but still
attempt the checks of other levels.
However, the level 4 checks are dependent on the level 3 checks being completed,
so that bitcoind can currently hit an assert and crash if `-checklevel=4` is
specified, but the level 3 checks weren't able to finish
([Issue 25563](https://github.com/bitcoin/bitcoin/issues/25563)).

- Since the default values are  `DEFAULT_CHECKBLOCKS == 6` and `DEFAULT_CHECKLEVEL == 3`,
users can't run into this issue unless they actively specify a higher checklevel
than the default.

- This PR prevents the assert from being hit during the checks and also changes
the way errors are reported and logged in both places VerifyDB is used (Init and RPC).


## Questions
1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)?

1. What is the reason the `VerifyDB` checks are important? Considering that they
can delay the startup by several seconds, what would be possible consequences of not
having these checks in place?

1. Can you describe the checks that each of the four levels of `VerifyDB` perform?
For which of the levels is the dbcache size relevant?

1. In the failure case, why exactly is the Assertion `hashPrevBlock == view.GetBestBlock()`
in [`Chainstate::ConnectBlock()`](https://github.com/bitcoin/bitcoin/blob/fe8d15c907d0ca170ce171e7655f9c7cd4a0194f/src/validation.cpp#L2023) hit?

1. Were you able to reproduce the `VerifyDB` crash on master and verify that
this branch prevents it? (Hint: use `-dbcache=1` as a startup arg to bitcoind)

1. In addition to fixing the crash, this PR also changes the way both
init and the `verifychain` RPC handle errors. Can you describe these?

1. Do you agree with the new error handling? Do you think bitcoind should abort if
the default checks couldn't be completed (but there was no corruption)?

<!-- TODO: After meeting, uncomment and add meeting log between the irc tags
## Meeting Log

{% irc %}
{% endirc %}
-->
