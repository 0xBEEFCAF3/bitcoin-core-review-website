---
layout: pr
date: 2023-01-25
title: "wallet: ensure the wallet is unlocked when needed for rescanning"
pr: 26347
authors: [ishaanam]
components: ["wallet"]
host: ishaanam
status: upcoming
commit: b2e2829
---
## Notes
- A wallet rescans the blockchain in order to find transactions related
  to its keys. A wallet starts rescanning the blockchain upon the import
  of keys, descriptors, etc. A rescan can also be invoked by calling
  [`rescanblockchain`](https://github.com/bitcoin/bitcoin/blob/306ccd4927a2efe325c8d84be1bdb79edeb29b04/src/wallet/rpc/transactions.cpp#L844).

- Wallet rescans were previously discussed in review clubs
  [#15845](/15845) and [#25957](/25957).

- When a wallet is rescanning, it needs to be able to top-up its keypool.

- A wallet's keypool is its reserve of unused keys of a denoted size (the
  default size is [1000 keys](https://github.com/bitcoin/bitcoin/blob/1aedc3b6c81ba5ecf96749be0fb59d873bfd6d49/src/wallet/scriptpubkeyman.h#L51)). When a wallet is using [BIP 32](https://github.com/bitcoin/bips/blob/a3a397c82384220fc871852c809f73898a4d547c/bip-0032.mediawiki)
  to generate deterministic keys, an unused key is considered to be any key
  whose BIP 32 index is greater than the index of the last key which was
  provided to the user by the wallet or which received funds.

- [`WalletRescanReserver`](https://github.com/bitcoin/bitcoin/blob/e9262ea32a6e1d364fb7974844fadc36f931f8c6/src/wallet/wallet.h#L951) is used to manage rescans in a wallet.

- Wallets can optionally be encrypted using a passphrase. Only the
  private key material of the wallet is encrypted using a user-provided
  passphrase.

- An encrypted wallet is [locked](https://github.com/bitcoin/bitcoin/blob/306ccd4927a2efe325c8d84be1bdb79edeb29b04/src/wallet/wallet.cpp#L3358) by default;
  it can be unlocked by calling [`walletpassphrase`](https://bitcoincore.org/en/doc/24.0.0/rpc/wallet/walletpassphrase/),
  which then stores the passphrase in memory for a specified amount of
  time before the wallet [is locked again](https://github.com/bitcoin/bitcoin/blob/306ccd4927a2efe325c8d84be1bdb79edeb29b04/src/wallet/rpc/encrypt.cpp#L91-L99)

- Certain RPCs which make use of information relating to private keys, such as
  [`sendtoaddress`](https://github.com/bitcoin/bitcoin/blob/39363a4b945114f5e4718f75098f3036e8fe6a1d/src/wallet/rpc/spend.cpp#L212) and [`signrawtransactionwithwallet`](https://github.com/bitcoin/bitcoin/blob/39363a4b945114f5e4718f75098f3036e8fe6a1d/src/wallet/rpc/spend.cpp#L840)
  require the wallet to be unlocked in order to work correctly. If the wallet is
  not unlocked, the RPC typically throws an error.

- The `cs_wallet` [mutex](https://en.wikipedia.org/wiki/Lock_(computer_science)) 
  [guards](https://github.com/bitcoin/bitcoin/blob/306ccd4927a2efe325c8d84be1bdb79edeb29b04/src/wallet/wallet.h#L239) access to the passphrase when stored in memory. For example, `cs_wallet` must be
  held before the passphrase can be deleted, so
  holding the `cs_wallet` mutex for the duration of the RPC ensures another thread
  cannot delete the passphrase while it is in use.

- The `rescanblockchain` and `importdescriptors` RPCs don't hold
  `cs_wallet` during the entire rescan, only for certain relatively fast
  operations, because a rescan can take over an hour, and the user might
  want to use other RPCs in the meantime which require the `cs_wallet`
  lock to be held.

## Questions
1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)?

1. What bug is this PR fixing?

1. Why can wallets that use unhardened derivation top up the keypool
without being unlocked? Would this problem occur when rescanning a
descriptor wallet with descriptors generated by Bitcoin Core?

1. Does the [test](https://github.com/bitcoin-core-review-club/bitcoin/commit/b2e2829014c5c9a3dc02eab7fcd77dd907228c78)
added to wallet_importdescriptors.py fail on master for you? Can you
think of any ways to make it fail on master more reliably?

1. What is this PR's approach to fixing this bug? Can you think of any alternatives?

1. Why was the `m_scanning_with_passphrase` variable added to `CWallet`?

1. Why is `wallet.m_scanning_with_passphrase` only set to `true` in some
RPCs and not others like `importpubkey` and `importprivkey`?

1. What would happen if the [first commit](https://github.com/bitcoin-core-review-club/bitcoin/commit/8c16fdb73dd323245642d2710b5f81776db40396)
of this PR was removed and a user tried to run `walletlock` while
performing a rescan that required the passphrase?

1. Why was another mutex added instead of just using `cs_wallet`?

1. Why is `RecursiveMutex` used here as opposed to `Mutex`?

1. Why does `m_relock_mutex` get locked twice in `walletlock`?

<!-- TODO: After meeting, uncomment and add meeting log between the irc tags
## Meeting Log

{% irc %}
{% endirc %}
-->

