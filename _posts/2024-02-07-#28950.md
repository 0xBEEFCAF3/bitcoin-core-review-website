
---
layout: pr
date: 2024-02-07
title: "Add `maxfeerate` and `maxburnamount` args to submitpackage"
pr: 28950
authors: [instagibbs]
components: ["rpc"]
host: ismaelsadeeq
status: upcoming
commit: bf6fbea9794db5e8d0adce8ff6182574808cea54
---

## Notes

- Package transactions submitted to the [`submitpackage`](https://bitcoincore.org/en/doc/26.0.0/rpc/rawtransactions/submitpackage/) RPC successfully are accepted to the node's mempool, but broadcasted to peers individually because [package relay](https://bitcoinops.org/en/topics/package-relay/) is currently a work in progress. Successful submission does not mean the transactions will propagate.

- `maxfeerate` is an optional parameter for the [`sendrawtransaction`](https://github.com/bitcoin-core-review-club/bitcoin/blob/bf6fbea9794db5e8d0adce8ff6182574808cea54/src/rpc/mempool.cpp#L35) and [`testmempoolaccept`](https://github.com/bitcoin-core-review-club/bitcoin/blob/bf6fbea9794db5e8d0adce8ff6182574808cea54/src/rpc/mempool.cpp#L104) RPCs. Transactions exceeding this feerate won't be added to mempool and broadcasted to peers, helping prevent unintentional overpayment.

- `maxburnamount` is a similar optional parameter for the `sendrawtransaction` RPC that helps prevent users from accidentally burning funds. Transactions with a data carrier `OP_RETURN` output amount that exceeds `maxburnamount` (default value: 0) are not submitted or broadcasted.

- Upon decoding a transaction in `sendrawtransaction` and `testmempoolaccept` RPCs, `maxburnamount` is checked immediatley.

- In the `sendrawtransaction` RPC, `maxfeerate` sanity check is performed by calculating the transaction size fee at `maxfeerate` fee rate (as [`max_raw_tx_fee`](https://github.com/bitcoin-core-review-club/bitcoin/blob/bf6fbea9794db5e8d0adce8ff6182574808cea54/src/rpc/mempool.cpp#L89)) which is passed to [`BroadcastTransaction`](https://github.com/bitcoin-core-review-club/bitcoin/blob/bf6fbea9794db5e8d0adce8ff6182574808cea54/src/node/transaction.cpp#L33), transactions whose base fee exceeds the `max_raw_tx_fee` are neither broadcasted nor added to the mempool.

- `testmempoolaccept` performs `maxfeerate` sanity check after package processing. It ensures that the individual base fee of all the successfully validated transactions [does not exceed](https://github.com/bitcoin-core-review-club/bitcoin/blob/bf6fbea9794db5e8d0adce8ff6182574808cea54/src/rpc/mempool.cpp#L218) the fee of the transaction size at `maxfeerate` fee rate.

- This PR adds optional parameters `maxfeerate` and `maxburnamount` to the [`submitpackage`](https://github.com/bitcoin-core-review-club/bitcoin/blob/bf6fbea9794db5e8d0adce8ff6182574808cea54/src/rpc/mempool.cpp#L816) RPC, enabling similar sanity checks on package transactions.

- After [decoding each package transaction in `submitpackage`](https://github.com/bitcoin/bitcoin/blob/e69796c79c0aa202087a13ba62d9fbcc1c8754d4/src/rpc/mempool.cpp#L814), the transaction outputs are subjected to a `maxburnamount` sanity check.

- The PR introduces the `max_sane_feerate` parameter to the [`ProcessNewPackage`](https://github.com/bitcoin-core-review-club/bitcoin/blob/bf6fbea9794db5e8d0adce8ff6182574808cea54/src/validation.h#L282) function. `submitpackage` now passes the value of `maxfeerate` as the `max_sane_feerate` when calling `ProcessNewPackage`.

- `ProcessNewPackage` is updated to forward the `max_sane_feerate` to [`AcceptPackage`](https://github.com/bitcoin-core-review-club/bitcoin/blob/bf6fbea9794db5e8d0adce8ff6182574808cea54/src/validation.cpp#L1450), which performs the sanity check during [`Sub package`](https://github.com/bitcoin-core-review-club/bitcoin/blob/bf6fbea9794db5e8d0adce8ff6182574808cea54/src/validation.cpp#L1425) evaluation.
    - Transactions with individual modified feerates exceeding `max_sane_feerate` will not accepted into the mempool, along with its descendants, as they will be missing input during their evaluation.

## Questions

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)? What was your review approach?

2. Why is it important to perform these sanity checks on submitted packages?

3. Are there other important sanity checks apart from `maxburnamount` and `maxfeerate` that should be performed on packages before they are accepted to the mempool?

4. The options `maxburnamount` and `maxfeerate` can prevent a transaction from entering the mempool and being relayed. Can we consider these options as policy rules? Why or why not?

5. The [bf6fbea97](https://github.com/bitcoin-core-review-club/bitcoin/commit/bf6fbea9794db5e8d0adce8ff6182574808cea54) commit message states: "This allows subpackage processing and is compatible with future package RBF work." What makes this compatible with future RBF work?

6. Why do we validate `maxfeerate` against the modified feerate instead of the base fee rate? 

7. We validate `maxfeerate` against the modified feerate of individual package transactions, not package feerate, this can sometimes be incentive incompatible.
    - How does this happen?
    - Why is it not a current concern? 
    - Under what conditions might it become problematic?

8. Why can't `maxfeerate` be checked immediately after decoding like `maxburnamount` is?

9. How does the `maxfeerate` sanity check in [`testmempoolaccept` RPC](https://github.com/bitcoin/bitcoin/blob/e69796c79c0aa202087a13ba62d9fbcc1c8754d4/src/rpc/mempool.cpp#L104) differ from `submitpackage` RPC? Why can't they be the same?

10. Is there another approach from the one taken by this PR? What are the tradeoffs?


<!-- TODO: After a meeting, uncomment and add meeting log between the irc tags
## Meeting Log
### Meeting 1
{% irc %}
-->
<!-- TODO: For additional meetings, add the logs to the same irc block. This ensures line numbers keep increasing, avoiding hyperlink conflicts for identical line numbers across meetings.
### Meeting 2
-->
{% endirc %}