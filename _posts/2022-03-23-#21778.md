---
layout: pr
date: 2022-03-23
title: "LLVM 14 & LLD based macOS toolchain"
pr: 21778
authors: [fanquake]
components: ["build system"]
host: fanquake
status: upcoming
commit:
---

## Notes

Bitcoin Core releases binaries for multiple different operating systems (Linux, Windows & macOS), produced using [cross-compilation](https://en.wikipedia.org/wiki/Cross_compiler) (on Linux). Historically, the project has used a very ["non-standard" toolchain](https://github.com/bitcoin/bitcoin/blob/master/contrib/macdeploy/README.md) for producing its macOS release binaries. This is primarily due to there not being any "official" way to build macOS binaries, using completely open source software, on a Linux system. The only Apple-sanctioned way to build macOS binaries is using the Xcode toolchain, running on macOS hardware.

Using a non-standard toolchain is not ideal for a number of reasons:

    * We are the only user. No one else is testing things, finding bugs, or making improvements.

    * Creating our toolchain is reliant on Apple (infrequently) [releasing source code](https://opensource.apple.com/source/) for the tools we need.

    * It's reliant on 3rd-parties patching those sources. i.e https://github.com/tpoechtrager/cctools-port

    * It's complicated.

The most promising alternative toolchain for producing macOS binaries on Linux, has been LLVMs `clang` + `lld`. However until recently, `lld` was unable to link large / complex programs. Much work has been done over the past few years [to re-write the Mach-O backend](https://reviews.llvm.org/rG03f43b3aca3) for `lld`, to where it is now able to link large, complex programs, i.e Chromium, as well as self-host. The new backend has now also [become the default](https://lists.llvm.org/pipermail/llvm-dev/2021-January/147665.html), [as of LLVM 13](https://reviews.llvm.org/D95204).

[#21778](https://github.com/bitcoin/bitcoin/pull/21778) is a work in progress attempt to transition our macOS toolchain to `clang` + `lld`, as opposed to our current, custom-built toolchain.

## Questions

1. Did you review the PR? [Concept ACK, approach ACK, tested ACK, or NACK](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#peer-review)?

2. Can you think of a reason why we might want to continue using our current macOS toolchain, rather than switch?

3. Did you try performing a [macOS cross compile](https://github.com/bitcoin/bitcoin/tree/master/depends#for-macos-cross-compilation)? Did it work? If not, what problems did you run into?

4. Do these changes effect our Guix (release) build process?
    * If so, how? (hint: look for usage of `FORCE_USE_SYSTEM_CLANG`)
    * Is there a Guix build change you'd expect to see, which is missing from the PR?

5. In `native_llvm`'s preprocessing step we `rm -rf lib/libc++abi.so*`:
    * Why do/did we do this? (remember we target a macOS SDK when building)
    * Is it actually necessary? (double-check what is ultimately copied from the tarball).

6. In `native_llvm.mk`, we copy a number of tools (i.e `llvm-*`, not `clang` or `lld`) out of the tarball:
    * What is one of them used for?
    * bonus: If we rename that tool when copying it, why might we do that?


<!-- TODO: After meeting, uncomment and add meeting log between the irc tags
## Meeting Log

{% irc %}
{% endirc %}
-->
